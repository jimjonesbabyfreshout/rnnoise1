var MIN_DB_LEVEL=-110,MAX_DB_LEVEL=-40,DB_LEVEL_RANGE=MAX_DB_LEVEL-MIN_DB_LEVEL,HEAT_COLORS=[];function generateHeatColors(){for(var e=0;e<256;e++)HEAT_COLORS.push("hsl("+240*(1-e/256)+", 100%, 50%)")}function clamp(e,t,i){return e<t&&(e=t),e>i&&(e=i),e}generateHeatColors();var DarkTheme={backgroundColor:"#000000"},LightTheme={backgroundColor:"#F5F5F5"},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),CanvasView=function(){function e(e,t,i){this.canvas=e,this.width=t,this.height=i,this.theme=DarkTheme,this.reset()}return e.prototype.reset=function(){this.ratio=window.devicePixelRatio||1,this.canvas.width=this.width*this.ratio,this.canvas.height=this.height*this.ratio,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.ctx=this.canvas.getContext("2d")},e.prototype.tick=function(){this.update(),this.render()},e.prototype.update=function(){},e.prototype.render=function(){},e}(),FrequencyBins=function(){function e(e,t){void 0===t&&(t=2),this.analyzerNode=e,this.skip=t;var i=this.analyzerNode.frequencyBinCount;this.temp=new Float32Array(i),this.bins=new Float32Array(i-t)}return e.prototype.update=function(){this.analyzerNode.getFloatFrequencyData(this.temp),this.bins.set(this.temp.subarray(this.skip))},e}(),AnalyzerNodeView=function(e){function t(t,i,n,o){var s=e.call(this,i,n,o)||this;return s.isRecording=!1,s.frequency=new FrequencyBins(t),s}return __extends(t,e),t}(CanvasView),SpectogramAnalyzerNodeView=function(e){function t(t,i,n,o){var s=e.call(this,t,i,n,o)||this;return s.binWidth=1,s.binHPadding=0,s.binTotalWidth=s.binWidth+s.binHPadding,s.tickHeight=2,s.tickVPadding=0,s.tickTotalHeight=s.tickHeight+s.tickVPadding,s.reset(),s}return __extends(t,e),t.prototype.reset=function(){e.prototype.reset.call(this),this.tmpCanvas=document.createElement("canvas"),this.tmpCanvas.width=this.canvas.width,this.tmpCanvas.height=this.canvas.height,this.tmpCtx=this.tmpCanvas.getContext("2d")},t.prototype.update=function(){this.frequency.update()},t.prototype.render=function(){var e=this.ctx;this.tmpCtx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height),e.save(),e.save(),e.scale(this.ratio,this.ratio),e.fillStyle=this.theme.backgroundColor,e.fillRect(0,0,this.width,this.height);for(var t=this.width/this.binTotalWidth|0,i=Math.min(t,this.frequency.bins.length),n=0;n<i/2|0;n++){var o=clamp((this.frequency.bins[n]-MIN_DB_LEVEL)/DB_LEVEL_RANGE,0,.995);e.globalAlpha=1,e.fillStyle=FF_MAP[o*FF_MAP.length|0],e.fillRect(this.width-this.binTotalWidth,(i/4-n-1)*this.tickTotalHeight,this.binWidth,this.tickHeight)}e.restore(),e.translate(-this.binTotalWidth,0),e.drawImage(this.tmpCanvas,0,0),e.restore()},t}(AnalyzerNodeView);let microphoneIsWiredUp=!1,microphoneAccessIsNotAllowed=void 0,uploadMicrophoneData=!1,suppressNoise=!1,addNoise=!1,mediaStream=null,animation=null,Module=null;function stopMicrophone(){microphoneIsWiredUp&&(mediaStream&&mediaStream.getTracks().forEach(e=>{e.stop()}),animation&&cancelAnimationFrame(animation),microphoneIsWiredUp=!1)}function getMicrophoneAccess(){if(microphoneIsWiredUp)return;var e;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,e=new AudioContext}catch(e){alert("Web Audio API is not supported in this browser.")}if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,!navigator.getUserMedia)return void alert("getUserMedia() is not supported in your browser.");var t=[],i=[],n=(e.sampleRate,e.createScriptProcessor(16384,1,1)),o=e.createScriptProcessor(16384,1,1);function s(e){let t=Module.ptr,i=Module.st;for(let i=0;i<480;i++)Module.HEAPF32[(t>>2)+i]=32768*e[i];Module._rnnoise_process_frame(i,t,t);for(let i=0;i<480;i++)e[i]=Module.HEAPF32[(t>>2)+i]/32768}o.onaudioprocess=function(e){var t=e.inputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(0);for(let e=0;e<t.length;e++)i[e]=addNoise?t[e]+Math.random()/100:t[e]};let a=[];n.onaudioprocess=function(e){var n=e.inputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(0);for(let e=0;e<16384;e++)t.push(n[e]);for(;t.length>=480;){for(let e=0;e<480;e++)a[e]=t.shift();suppressNoise&&s(a);for(let e=0;e<480;e++)i.push(a[e])}if(!(i.length<16384))for(let e=0;e<16384;e++)o[e]=i.shift()},navigator.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}},function(t){mediaStream=t;var i=e.createMediaStreamSource(t),s=e.createAnalyser(),a=e.createAnalyser();s.smoothingTimeConstant=0,a.smoothingTimeConstant=0,s.fftSize=1024,a.fftSize=1024,i.connect(o),o.connect(s),s.connect(n),n.connect(a),a.connect(e.destination),microphoneIsWiredUp=!0;var r=new SpectogramAnalyzerNodeView(s,document.getElementById("source_spectrogram"),876,256),d=new SpectogramAnalyzerNodeView(a,document.getElementById("destination_spectrogram"),876,256);animation=requestAnimationFrame(function e(){r.tick(),d.tick(),animation=requestAnimationFrame(e)})},function(e){"PermissionDeniedError"===e.name&&(microphoneAccessIsNotAllowed=!0,alert("You'll need to provied access to your microphone for this web page to work."))})}function convertFloat32ToInt16(e){let t=e.length,i=new Int16Array(t);for(;t--;)i[t]=32767*Math.min(1,e[t]);return i}let uploadedPackets=0;function postData(e){let t=document.getElementById("streaming_status");var i=new FormData;i.append("author","Fake Name"),i.append("attachment1",new Blob([e]));var n=new XMLHttpRequest;n.open("POST","https://demo.xiph.org/upload"),n.onload=function(e){uploadedPackets++,t.innerText="Donated "+uploadedPackets+" seconds of noise (of 60).",uploadedPackets>=60&&(stopStreaming(),stopMicrophone())},n.send(i)}function stopStreaming(){}function startStreaming(){let e=document.getElementById("streaming_button");document.getElementById("streaming_status_icon").style.visibility="visible",uploadMicrophoneData=!0,e.innerText="Stop donating my noise!"}function toggleStreaming(){getMicrophoneAccess(),uploadMicrophoneData?stopStreaming():startStreaming()}function initializeNoiseSuppressionModule(){Module||(Module={noExitRuntime:!0,noInitialRun:!0,preInit:[],preRun:[],postRun:[function(){console.log("Loaded Javascript Module OK")}],memoryInitializerPrefixURL:"bin/",arguments:["input.ivf","output.raw"]},NoiseModule(Module),Module.st=Module._rnnoise_create(),Module.ptr=Module._malloc(1920))}function toggleNoise(){addNoise=!addNoise}var selectedLiveNoiseSuppression=null;function liveNoiseSuppression(e,t){selectedLiveNoiseSuppression&&selectedLiveNoiseSuppression.classList.remove("selected"),selectedLiveNoiseSuppression=t,t.classList.add("selected"),0!=e?(getMicrophoneAccess(),initializeNoiseSuppressionModule(),stopStreaming(),1==e?suppressNoise=!1:2==e&&(suppressNoise=!0)):stopMicrophone()}var hidden,visibilityChange,selectedLiveNoise=null;function liveNoise(e,t){addNoise=!!e,selectedLiveNoise&&selectedLiveNoise.classList.remove("selected"),selectedLiveNoise=t,t.classList.add("selected")}function handleVisibilityChange(){document[hidden]&&liveNoiseSuppression(0,document.getElementById("default_live_noise_suppression"))}void 0!==document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):void 0!==document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange"),void 0!==document.addEventListener&&void 0!==document[hidden]&&document.addEventListener(visibilityChange,handleVisibilityChange,!1);
